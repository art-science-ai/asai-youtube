name: build-pr
on:
  pull_request:
    branches: [ main ]

jobs:
  # Stage 1: Fast Validation - runs first to catch simple errors quickly
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: DeterminateSystems/nix-installer-action@v12
      - uses: DeterminateSystems/magic-nix-cache-action@v7

      - name: Check flake structure
        run: nix flake check --all-systems

      - name: Check code formatting
        run: |
          nix run nixpkgs#nixfmt-rfc-style -- --check .

  # Stage 2: Build Verification - runs after validation passes
  build:
    needs: validate
    strategy:
      fail-fast: false
      matrix:
        include:
          - runner: ubuntu-24.04
            system: x86_64-linux
          - runner: macos-14
            system: aarch64-darwin
    runs-on: ${{ matrix.runner }}
    steps:
      - uses: actions/checkout@v4
      - uses: DeterminateSystems/nix-installer-action@v12
      - uses: DeterminateSystems/magic-nix-cache-action@v7

      - name: Build system configurations
        run: |
          if [ "${{ matrix.system }}" = "x86_64-linux" ]; then
            echo "Building NixOS configurations..."
            nix build \
              .#nixosConfigurations.seasmoke.config.system.build.toplevel \
              .#nixosConfigurations.vermax.config.system.build.toplevel \
              --print-build-logs
          elif [ "${{ matrix.system }}" = "aarch64-darwin" ]; then
            echo "Building Darwin configurations..."
            nix build \
              .#darwinConfigurations.meleys.config.system.build.toplevel \
              .#darwinConfigurations.moondancer.config.system.build.toplevel \
              --print-build-logs
          fi

      - name: Build home configurations
        run: |
          if [ "${{ matrix.system }}" = "x86_64-linux" ]; then
            echo "Building Linux home configurations..."
            nix build \
              '.#homeConfigurations."nikhilmaddirala@seasmoke".activationPackage' \
              '.#homeConfigurations."tyrion@seasmoke".activationPackage' \
              '.#homeConfigurations."aegon@seasmoke".activationPackage' \
              '.#homeConfigurations."nikhilmaddirala@vermax".activationPackage' \
              --print-build-logs
          elif [ "${{ matrix.system }}" = "aarch64-darwin" ]; then
            echo "Building macOS home configurations..."
            nix build \
              '.#homeConfigurations."nikhilmaddirala@meleys".activationPackage' \
              '.#homeConfigurations."nikhilmaddirala@moondancer".activationPackage' \
              --print-build-logs
          fi
