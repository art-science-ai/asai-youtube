---
phase: 01-cli-indexer
type: execute
---

<objective>
Build a complete CLI tool that indexes directories into markdown files with YAML frontmatter metadata.

Purpose: Create a lightweight tool for maintaining file metadata and personal notes on external directories.
Output: Working Python CLI script that generates and updates markdown index files.
</objective>

<execution_context>
./.claude/get-shit-done/workflows/execute-phase.md
./.planning/phases/01-cli-indexer/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CLI skeleton with argparse</name>
  <files>src/dir_index.py</files>
  <action>Create executable Python script with argparse CLI that accepts:
  - Positional argument: target directory path
  - Optional flag: --output-dir (default: current working directory)
  Use uv script metadata format: #!/usr/bin/env -S uv run --script
  Include requires-python = ">=3.11" and dependencies = ["pyyaml>=6.0"]
  Create main() function that parses args and calls index_directory()</action>
  <verify>./src/dir_index.py --help shows usage with target-dir argument and --output-dir option</verify>
  <done>CLI parses arguments correctly, script is executable with uv run</done>
</task>

<task type="auto">
  <name>Task 2: Implement directory traversal</name>
  <files>src/dir_index.py</files>
  <action>Add recursive directory walk using pathlib.Path.rglob():
  - Traverse target directory recursively
  - Collect both files and directories with metadata
  - For each item, capture: path (relative to target), size (bytes), modified_time (mtime), type (file/dir)
  - Handle permission errors gracefully (skip, log warning)
  - Return list of FileItem dataclass/namedtuple with all metadata</action>
  <verify>Test on sample directory: ./src/dir_index.py /path/to/dir prints count of files/dirs found</verify>
  <done>Recursively traverses nested directories, captures all required metadata fields</done>
</task>

<task type="auto">
  <name>Task 3: Generate markdown files with YAML frontmatter</name>
  <files>src/dir_index.py</files>
  <action>For each file/directory from traversal, create markdown file in output directory:
  - Filename: sanitize path (replace slashes with dashes, e.g., "subdir-file.md")
  - YAML frontmatter with: path, size, modified_date (ISO format), type
  - Empty markdown body (for manual notes)
  - Use pyyaml to dump frontmatter with default_flow_style=False
  - Create output directory if it doesn't exist
  - Preserve directory structure: group by parent dir in output</action>
  <verify>Run on test directory: output/*.md files created with valid YAML frontmatter containing all metadata</verify>
  <done>Each file/directory gets corresponding markdown file with complete YAML metadata, empty body for notes</done>
</task>

<task type="auto">
  <name>Task 4: Implement metadata sync on re-run</name>
  <files>src/dir_index.py</files>
  <action>Add smart update logic:
  - Check if markdown file already exists for each item
  - If exists: read current file, extract existing markdown body, update YAML frontmatter with new metadata, preserve body
  - If not exists: create new file (as in Task 3)
  - Use yaml.safe_load() to parse existing frontmatter, split on first '---' to separate body
  - Handle corrupted files (overwrite with new, log warning)
  - Skip if metadata unchanged (optional optimization)</action>
  <verify>Run twice on same directory: second run updates YAML timestamps but preserves manually added markdown body content</verify>
  <done>Re-running updates metadata fields while preserving any manual notes added to markdown body</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `./src/dir_index.py --help` shows correct usage
- [ ] `./src/dir_index.py /tmp/test-dir` creates markdown files in output directory
- [ ] Each markdown file has valid YAML frontmatter with path, size, modified_date, type
- [ ] Re-running updates metadata but preserves markdown body content
- [ ] Nested directories are handled correctly
</verification>

<success_criteria>

- All tasks completed
- CLI tool works end-to-end on test directory
- Markdown files generated with correct YAML structure
- Metadata sync preserves manual notes on re-run
- No errors on common edge cases (permission errors, existing files, nested dirs)
  </success_criteria>

<output>
After completion, create `.planning/phases/01-cli-indexer/01-01-SUMMARY.md`:

# Phase 1 Plan 1: CLI Indexer Summary

**Lightweight CLI tool for directory indexing with markdown metadata files**

## Accomplishments

- Built executable Python CLI with argparse and uv script metadata
- Implemented recursive directory traversal with pathlib
- Generated markdown files with YAML frontmatter containing file metadata
- Added smart metadata sync that preserves manual notes on re-runs

## Files Created/Modified

- `src/dir_index.py` - Complete CLI tool with all functionality

## Decisions Made

- Used uv script metadata format for dependency-free execution
- Sanitized filenames by replacing path separators with dashes
- Preserved markdown body during updates by splitting on first '---' separator

## Issues Encountered

None

## Next Step

Phase complete - ready to test and use
</output>
