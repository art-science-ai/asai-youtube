---
phase: 02-record-extraction
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/agents/__init__.py
  - src/agents/extraction_agent.py
  - src/models/__init__.py
  - src/models/medical_record.py
  - .env.example
autonomous: true
user_setup:
  - service: anthropic
    why: "Claude API for medical data extraction"
    env_vars:
      - name: ANTHROPIC_API_KEY
        source: "https://console.anthropic.com/settings/keys"

must_haves:
  truths:
    - "Agent can extract Diagnosis from transcript text"
    - "Agent can extract Plan from transcript text"
    - "Agent can extract Prescriptions from transcript text"
    - "Extraction results are validated using Pydantic schemas"
    - "Agent uses Claude tool use pattern (not direct JSON prompting)"
    - "Agent uses AsyncAnthropic client (not sync - prevents UI blocking)"
  artifacts:
    - path: "src/models/medical_record.py"
      provides: "Pydantic model for structured medical data"
      contains: "class MedicalExtraction"
    - path: "src/agents/extraction_agent.py"
      provides: "Claude agent orchestration for extraction"
      exports: ["extract_medical_data", "run_extraction"]
    - path: ".env.example"
      provides: "Environment variable template"
      contains: "ANTHROPIC_API_KEY"
  key_links:
    - from: "src/agents/extraction_agent.py"
      to: "src/models/medical_record.py"
      via: "Pydantic model import"
      pattern: "from.*models.*import.*MedicalExtraction"
    - from: "src/agents/extraction_agent.py"
      to: "anthropic.messages"
      via: "Claude API client"
      pattern: "from anthropic import.*beta_tool"
    - from: "src/agents/extraction_agent.py"
      to: "anthropic.AsyncAnthropic"
      via: "Async client instantiation (prevents UI blocking)"
      pattern: "AsyncAnthropic\\(api_key=api_key\\)"
---

<objective>
Implement Claude agent with tool use for extracting structured medical data (Diagnosis, Plan, Prescriptions) from visit transcripts.

Purpose: Enable AI-powered extraction of medical information from unstructured transcript text, providing validated, structured output ready for database storage.
Output: Working extraction agent with Pydantic validation and Claude tool use integration.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-record-extraction/02-RESEARCH.md
@app.py
@database.py

# Prior phase foundation
@.planning/phases/01-foundation/01-01-SUMMARY.md
@.planning/phases/01-foundation/01-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Pydantic model for medical extraction</name>
  <files>src/models/medical_record.py</files>
  <action>
  Create Pydantic v2 model for structured medical data extraction:

  1. Create src/models/__init__.py (empty file)
  2. Create src/models/medical_record.py with:
     - MedicalExtraction(BaseModel) class with fields:
       * diagnosis: str (Field description: "Primary diagnosis from the visit")
       * plan: str (Field description: "Treatment plan and recommendations")
       * prescriptions: str (Field description: "Prescribed medications with dosages")
     - Use pydantic.Field for descriptive metadata (helps Claude extraction)
     - Add model_config = {"json_schema_mode": "validation"} for strict validation
     - Include example in model docstring for Claude context

  Why Pydantic: Research shows auto-generated JSON schemas from Pydantic keep extraction in sync with types, and Anthropic's beta_tool decorator requires Pydantic v2.
  </action>
  <verify>
  Test in Python REPL:
  ```python
  from src.models.medical_record import MedicalExtraction
  test = MedicalExtraction(
    diagnosis="Hypertension",
    plan="Lifestyle changes",
    prescriptions="Lisinopril 10mg"
  )
  assert test.diagnosis == "Hypertension"
  print(test.model_json_schema())  # Should output valid JSON schema
  ```
  </verify>
  <done>MedicalExtraction model exists with diagnosis, plan, prescriptions fields and validates input correctly</done>
</task>

<task type="auto">
  <name>Task 2: Implement Claude extraction agent with tool use</name>
  <files>src/agents/extraction_agent.py</files>
  <action>
  Create extraction agent using Anthropic SDK tool use pattern:

  1. Create src/agents/__init__.py
  2. Create src/agents/extraction_agent.py with:

  **Imports:**
  - from anthropic import beta_tool, AsyncAnthropic
  - from pydantic import BaseModel
  - Import MedicalExtraction from src.models.medical_record

  **Tool function (decorated with @beta_tool):**
  ```python
  @beta_tool
  def extract_medical_data(transcript: str) -> MedicalExtraction:
      """
      Extract structured medical data from a visit transcript.

      Args:
          transcript: Full text of doctor-patient conversation

      Returns:
          MedicalExtraction with diagnosis, plan, and prescriptions
      """
      pass  # Claude calls this, we validate the result
  ```

  **Extraction orchestration function:**
  ```python
  async def run_extraction(transcript: str, api_key: str) -> MedicalExtraction:
      """
      Run medical data extraction using Claude tool use.

      Args:
          transcript: Full text of visit transcript
          api_key: Anthropic API key

      Returns:
          MedicalExtraction with extracted data

      Raises:
          Exception: If extraction fails or Claude doesn't call tool
      """
      client = AsyncAnthropic(api_key=api_key)

      system_prompt = """You are a medical documentation assistant. Extract structured medical data from visit transcripts.
      Focus on accurate diagnosis, clear treatment plans, and complete prescription information."""

      user_message = f"""Extract the following information from this transcript:

  {transcript}

  Use the extract_medical_data tool to provide the extracted information."""

      # Call Claude with tool
      response = await client.messages.create(
          model="claude-sonnet-4-5-20250929",
          max_tokens=4096,
          system=system_prompt,
          messages=[{"role": "user", "content": user_message}],
          tools=[extract_medical_data],
      )

      # Extract tool use from response
      tool_use = next(block for block in response.content if block.type == "tool_use")

      # Validate and return MedicalExtraction
      return MedicalExtraction(**tool_use.input)
  ```

  **Error handling:**
  - Raise Exception if response.stop_reason != "tool_use"
  - Raise Exception if no tool_use block found in response
  - Let Pydantic validation errors propagate (shows Claude provided invalid data)

  Why AsyncAnthropic: Research shows Chainlit handlers are async, using sync client blocks UI (Pitfall 4).
  </action>
  <verify>
  Create test_transcript.txt with sample medical conversation, then test:
  ```python
  import asyncio
  from src.agents.extraction_agent import run_extraction

  async def test():
      with open("test_transcript.txt") as f:
          transcript = f.read()
      result = await run_extraction(transcript, api_key="sk-ant-...")
      print(f"Diagnosis: {result.diagnosis}")
      print(f"Plan: {result.plan}")
      print(f"Prescriptions: {result.prescriptions}")

  asyncio.run(test())
  ```
  Expected: Extraction returns validated MedicalExtraction with all fields populated.

  CRITICAL: Verify AsyncAnthropic is used (not sync Anthropic):
  ```bash
  grep -n "AsyncAnthropic" src/agents/extraction_agent.py
  ```
  Expected: Line showing `client = AsyncAnthropic(api_key=api_key)`
  </verify>
  <done>run_extraction() function successfully calls Claude using AsyncAnthropic, extracts medical data using tool use, and returns validated MedicalExtraction instance</done>
</task>

<task type="auto">
  <name>Task 3: Add environment configuration template</name>
  <files>.env.example</files>
  <action>
  Create .env.example file with Anthropic API key template:

  ```
  # Anthropic API Configuration
  # Get your API key from: https://console.anthropic.com/settings/keys
  ANTHROPIC_API_KEY=sk-ant-...
  ```

  This provides a template for users to set up their API key without committing secrets to git.
  </action>
  <verify>
  ```bash
  cat .env.example
  ```
  Expected: File contains ANTHROPIC_API_KEY placeholder with comment pointing to API console.
  </verify>
  <done>.env.example exists with ANTHROPIC_API_KEY template and setup instructions</done>
</task>

</tasks>

<verification>
1. Pydantic model validates correctly with test data
2. Extraction agent calls Claude tool use using AsyncAnthropic (not sync client)
3. Environment template provides clear API key setup instructions
4. All code follows async patterns (no blocking operations)
5. Tool use pattern implemented (not direct JSON prompting)
6. grep confirms AsyncAnthropic client is instantiated (not Anthropic)
</verification>

<success_criteria>
1. Can instantiate MedicalExtraction with diagnosis, plan, prescriptions
2. run_extraction() calls Claude API using AsyncAnthropic and receives tool_use response
3. Extracted data passes Pydantic validation
4. .env.example provides template for API key configuration
5. Code verification shows AsyncAnthropic import and usage (not sync client)
</success_criteria>

<output>
After completion, create `.planning/phases/02-record-extraction/02-01-SUMMARY.md`
</output>
