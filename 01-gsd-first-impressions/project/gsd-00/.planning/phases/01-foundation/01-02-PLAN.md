---
phase: 01-foundation
plan: 02
type: execute
wave: 2
depends_on: [01-01]
files_modified:
  - app.py
  - database.py
  - patient_records.db
  - requirements.txt
autonomous: true
user_setup: []

must_haves:
  truths:
    - "SQLite database file is created automatically on first run"
    - "Database schema stores patient records with Diagnosis, Plan, Prescriptions, and timestamp"
    - "User can save patient records through chat interface"
    - "User can look up patient records by patient name or ID"
    - "Database operations integrate with Chainlit message handlers"
  artifacts:
    - path: "database.py"
      provides: "SQLite database connection and CRUD operations"
      min_lines: 80
      contains: ["create_patient_record", "get_patient_record", "init_db"]
    - path: "patient_records.db"
      provides: "SQLite database file"
      exists: true
    - path: "app.py"
      provides: "Updated message handlers for database operations"
      contains: ["save.*patient", "lookup.*patient"]
  key_links:
    - from: "app.py"
      to: "database.py"
      via: "import database module and call functions"
      pattern: "import database|database\\.(create|get|init)"
    - from: "database.py"
      to: "patient_records.db"
      via: "sqlite3 connection"
      pattern: "sqlite3\\.connect|patient_records\\.db"
    - from: "user chat input"
      to: "database operations"
      via: "command parsing in message handler"
      pattern: "message\\.content|save|lookup"
---

<objective>
Create SQLite database schema for patient records and integrate with Chainlit chat interface for saving and looking up patient records.

Purpose: Enable persistent storage of patient data (Diagnosis, Plan, Prescriptions) with simple lookup functionality.
Output: Working SQLite database with CRUD operations accessible through chat commands.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/REQUIREMENTS.md
@.planning/ROADMAP.md

# Prior plan context
@.planning/phases/01-foundation/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create database module with schema initialization</name>
  <files>database.py</files>
  <action>
    Create database.py with SQLite schema and CRUD operations.

    Must implement:
    - init_db() function: Creates patient_records table if not exists
      - Columns: id (INTEGER PRIMARY KEY), patient_name (TEXT), patient_id (TEXT), diagnosis (TEXT), plan (TEXT), prescriptions (TEXT), created_at (TIMESTAMP DEFAULT CURRENT_TIMESTAMP)
    - create_patient_record(patient_name, patient_id, diagnosis, plan, prescriptions) function: Inserts new record
    - get_patient_record(identifier) function: Searches by patient_name OR patient_id (returns most recent match)
    - Use sqlite3 module (no external ORM needed)
    - Auto-create patient_records.db file in project root if it doesn't exist

    Error handling:
    - Wrap sqlite3 operations in try/except
    - Return None or empty list on errors
    - Print errors to stderr for debugging

    Reference the existing app.py structure from 01-01 for integration.
  </action>
  <verify>grep -E "(init_db|create_patient_record|get_patient_record)" database.py returns 3 matches</verify>
  <done>database.py exists with all required functions</done>
</task>

<task type="auto">
  <name>Task 2: Update app.py with database integration</name>
  <files>app.py</files>
  <action>
    Modify app.py to integrate database operations.

    Add to app.py:
    - Import database module at top
    - Call database.init_db() in @chainlit.on_chat_start (ensures DB exists on startup)
    - Update @chainlit.on_message handler to support commands:
      - Command pattern: "save: patient_name|patient_id|diagnosis|plan|prescriptions" (pipe-separated)
      - Command pattern: "lookup: patient_name_or_id"
    - For save command: Parse input, call database.create_patient_record(), confirm save with message
    - For lookup command: Call database.get_patient_record(), format and display results
    - For regular text: Echo message with help text showing available commands

    Format lookup results as readable message with:
    - Patient Name/ID
    - Diagnosis
    - Plan
    - Prescriptions
    - Created timestamp

    Keep it simple — no complex command parsing, just string split by ": " and "|".
  </action>
  <verify>grep -E "(database\.init_db|database\\.create|database\\.get)" app.py returns matches</verify>
  <done>app.py message handlers integrate database functions</done>
</task>

<task type="auto">
  <name>Task 3: Test database operations end-to-end</name>
  <files>database.py, app.py</files>
  <action>
    Verify database operations work correctly.

    Test sequence:
    1. Run: python -c "import database; database.init_db()" (creates DB)
    2. Verify: patient_records.db file exists
    3. Run: python -c "import database; database.create_patient_record('John Doe', 'P001', 'Hypertension', 'Lifestyle changes', 'Lisinopril 10mg')"
    4. Run: python -c "import database; print(database.get_patient_record('John Doe'))"
    5. Verify: Record is returned with correct data

    If any test fails, fix database.py before proceeding.

    Do NOT start Chainlit server — this is unit testing the database layer only.
  </action>
  <verify>
    test -f patient_records.db && echo "DB file exists"
    python -c "import database; r = database.get_patient_record('John Doe'); print('Found' if r else 'Not found')"
  </verify>
  <done>Database CRUD operations work correctly with test data</done>
</task>

</tasks>

<verification>
After completing all tasks, verify:

1. database.py exists with init_db(), create_patient_record(), get_patient_record() functions
2. patient_records.db file is created after running init_db()
3. app.py imports database module and calls init_db() on chat start
4. app.py supports "save:" and "lookup:" commands in message handler
5. Database operations complete without errors
6. Lookup returns formatted patient data

Run this verification:
```bash
python -c "import database; database.init_db()" && test -f patient_records.db && echo "DB created"
python -c "import database; database.create_patient_record('Test Patient', 'T001', 'Test Diagnosis', 'Test Plan', 'Test Meds')"
python -c "import database; r = database.get_patient_record('Test Patient'); print('Test passed' if r and r['patient_name'] == 'Test Patient' else 'Test failed')"
grep -q "database.init_db" app.py && echo "DB init in app.py"
```
</verification>

<success_criteria>
- [ ] database.py implements init_db(), create_patient_record(), get_patient_record()
- [ ] SQLite schema stores patient_name, patient_id, diagnosis, plan, prescriptions, created_at
- [ ] patient_records.db file is created on first run
- [ ] app.py integrates database module (import and init_db call)
- [ ] app.py supports "save:" and "lookup:" commands
- [ ] Database operations complete without errors
- [ ] Lookup retrieves and displays patient records correctly
- [ ] Commands are documented in help text in app.py
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-02-SUMMARY.md`
</output>
